<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Cloth</title>
	<style>*{margin:0;padding:0;}body{background:#000;}canvas{display:block;margin:0 auto;}</style>
</head>
<body>
	<canvas id="can"></canvas>
	<script>function update(){ctx.clearRect(0,0,canvas.width,canvas.height),cloth.update(),cloth.draw(),requestAnimFrame(update)}function start(){canvas.addEventListener("mousedown",function(t){mouse.button=t.which,mouse.px=mouse.x,mouse.py=mouse.y;var n=canvas.getBoundingClientRect();mouse.x=t.clientX-n.left,mouse.y=t.clientY-n.top,mouse.down=!0,t.preventDefault()}),canvas.addEventListener("mousemove",function(t){mouse.px=mouse.x,mouse.py=mouse.y;var n=canvas.getBoundingClientRect();mouse.x=t.clientX-n.left,mouse.y=t.clientY-n.top,t.preventDefault()}),canvas.addEventListener("mouseup",function(t){mouse.down=!1,t.preventDefault()}),canvas.addEventListener("touchstart",function(t){mouse.button=1,mouse.px=mouse.x,mouse.py=mouse.y;var n=canvas.getBoundingClientRect();mouse.x=t.touches[0].clientX-n.left,mouse.y=t.touches[0].clientY-n.top,mouse.down=!0,t.preventDefault()}),canvas.addEventListener("touchmove",function(t){mouse.px=mouse.x,mouse.py=mouse.y;var n=canvas.getBoundingClientRect();mouse.x=t.touches[0].clientX-n.left,mouse.y=t.touches[0].clientY-n.top,t.preventDefault()}),canvas.addEventListener("touchend",function(t){mouse.down=!1,t.preventDefault()}),canvas.addEventListener("contextmenu",function(t){t.preventDefault()}),boundsx=canvas.width-1,boundsy=canvas.height-1,cloth_width=Math.floor(.1*canvas.width),cloth_height=Math.floor(.08*canvas.height),start_x=canvas.width/2-cloth_width*spacing/2,start_y=.01*canvas.height,ctx.strokeStyle="#98f",cloth=new Cloth,update()}var physics_accuracy=3,tear_distance=100,mouse_influence=20,mouse_cut=5,gravity=1200,spacing=7,cloth_height=null,cloth_width=null,start_x=null,start_y=null;window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)};var canvas,ctx,cloth,boundsx,boundsy,mouse={down:!1,button:1,x:0,y:0,px:0,py:0},Point=function(t,n){this.x=t,this.y=n,this.px=t,this.py=n,this.vx=0,this.vy=0,this.pin_x=null,this.pin_y=null,this.constraints=[]};Point.prototype.update=function(t){if(mouse.down){var n=this.x-mouse.x,s=this.y-mouse.y,i=Math.sqrt(n*n+s*s);1==mouse.button?mouse_influence>i&&(this.px=this.x-1.8*(mouse.x-mouse.px),this.py=this.y-1.8*(mouse.y-mouse.py)):mouse_cut>i&&(this.constraints=[])}this.add_force(0,gravity),t*=t,nx=this.x+.99*(this.x-this.px)+this.vx/2*t,ny=this.y+.99*(this.y-this.py)+this.vy/2*t,this.px=this.x,this.py=this.y,this.x=nx,this.y=ny,this.vy=this.vx=0},Point.prototype.draw=function(){if(this.constraints.length)for(var t=this.constraints.length;t--;)this.constraints[t].draw()},Point.prototype.resolve_constraints=function(){if(null!=this.pin_x&&null!=this.pin_y)return this.x=this.pin_x,void(this.y=this.pin_y);for(var t=this.constraints.length;t--;)this.constraints[t].resolve();this.x>boundsx?this.x=2*boundsx-this.x:1>this.x&&(this.x=2-this.x),this.y<1?this.y=2-this.y:this.y>boundsy&&(this.y=2*boundsy-this.y)},Point.prototype.attach=function(t){this.constraints.push(new Constraint(this,t))},Point.prototype.remove_constraint=function(t){this.constraints.splice(this.constraints.indexOf(t),1)},Point.prototype.add_force=function(t,n){this.vx+=t,this.vy+=n},Point.prototype.pin=function(t,n){this.pin_x=t,this.pin_y=n};var Constraint=function(t,n){this.p1=t,this.p2=n,this.length=spacing};Constraint.prototype.resolve=function(){var t=this.p1.x-this.p2.x,n=this.p1.y-this.p2.y,s=Math.sqrt(t*t+n*n),i=(this.length-s)/s;if(s>tear_distance){var o=start_x+cloth_width*spacing;this.p2.x==o?console.log("fuck!"):this.p1.remove_constraint(this)}var e=t*i*.5,h=n*i*.5;this.p1.x+=e,this.p1.y+=h,this.p2.x-=e,this.p2.y-=h},Constraint.prototype.draw=function(){ctx.moveTo(this.p1.x,this.p1.y),ctx.lineTo(this.p2.x,this.p2.y)};var Cloth=function(){this.points=[];for(var t=0;cloth_height>=t;t++)for(var n=0;cloth_width>=n;n++){var s=new Point(start_x+n*spacing,start_y+t*spacing);0!=n&&s.attach(this.points[this.points.length-1]),0==t&&s.pin(s.x,s.y),0!=t&&s.attach(this.points[n+(t-1)*(cloth_width+1)]),this.points.push(s)}};Cloth.prototype.update=function(){for(var t=physics_accuracy;t--;)for(var n=this.points.length;n--;)this.points[n].resolve_constraints();for(t=this.points.length;t--;)this.points[t].update(.016)},Cloth.prototype.draw=function(){ctx.beginPath();for(var t=cloth.points.length;t--;)cloth.points[t].draw();ctx.stroke()},window.onload=function(){canvas=document.getElementById("can"),ctx=canvas.getContext("2d"),canvas.width=window.innerWidth,canvas.height=window.innerHeight,start()};</script>
</body>
</html>